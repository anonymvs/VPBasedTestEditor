/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/rete-module-plugin@0.4.1/build/module-plugin.common.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var rete=require("rete");function asyncGeneratorStep(e,t,n,r,u,a,o){try{var i=e[a](o),s=i.value}catch(e){return void n(e)}i.done?t(s):Promise.resolve(s).then(r,u)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise(function(r,u){var a=e.apply(t,n);function o(e){asyncGeneratorStep(a,r,u,o,i,"next",e)}function i(e){asyncGeneratorStep(a,r,u,o,i,"throw",e)}o(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function extractNodes(e,t){var n=Array.from(t.keys());return Object.keys(e).filter(function(t){return n.includes(e[t].name)}).map(function(t){return e[t]}).sort(function(e,t){return e.position[1]>t.position[1]})}function removeIO(e,t){e.getConnections().forEach(function(e){return t.removeConnection(e)}),Array.from(e.inputs.values()).forEach(function(t){return e.removeInput(t)}),Array.from(e.outputs.values()).forEach(function(t){return e.removeOutput(t)})}function addIO(e,t,n){var r=new Set(t.map(function(e){return e.name})).size,u=new Set(n.map(function(e){return e.name})).size;if(r!==t.length)throw"Module ".concat(e.data.module," has duplicate inputs");if(u!==n.length)throw"Module ".concat(e.data.module," has duplicate outputs");t.forEach(function(t){return e.addInput(new rete.Input(t.name,t.name,t.socket))}),n.forEach(function(t){return e.addOutput(new rete.Output(t.name,t.name,t.socket))})}var Module=function(){function e(){_classCallCheck(this,e),this.inputs={},this.outputs={}}return _createClass(e,[{key:"read",value:function(e){this.inputs=e}},{key:"write",value:function(e){var t=this;Object.keys(this.outputs).map(function(n){e[n]=t.outputs[n]})}},{key:"getInput",value:function(e){return this.inputs[e]}},{key:"setOutput",value:function(e,t){this.outputs[e]=t}}]),e}(),ModuleManager=function(){function e(t){_classCallCheck(this,e),this.engine=null,this.modules=t,this.inputs=new Map,this.outputs=new Map}return _createClass(e,[{key:"getInputs",value:function(e){var t=this;return extractNodes(e.nodes,this.inputs).map(function(e){return{name:e.data.name,socket:t.socketFactory(e,t.inputs.get(e.name))}})}},{key:"getOutputs",value:function(e){var t=this;return extractNodes(e.nodes,this.outputs).map(function(e){return{name:e.data.name,socket:t.socketFactory(e,t.outputs.get(e.name))}})}},{key:"socketFactory",value:function(e,t){if(!(t="function"==typeof t?t(e):t))throw new Error("Socket not found for node with id = ".concat(e.id," in the module"));return t}},{key:"registerInput",value:function(e,t){this.inputs.set(e,t)}},{key:"registerOutput",value:function(e,t){this.outputs.set(e,t)}},{key:"workerModule",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n,r,u){var a,o,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.data.module){e.next=2;break}return e.abrupt("return");case 2:if(this.modules[t.data.module]){e.next=4;break}return e.abrupt("return");case 4:return a=this.modules[t.data.module].data,o=new Module,i=this.engine.clone(),o.read(n),e.next=10,i.process(a,null,Object.assign({},u,{module:o,silent:!0}));case 10:o.write(r);case 11:case"end":return e.stop()}},e,this)}));return function(t,n,r,u){return e.apply(this,arguments)}}()},{key:"workerInputs",value:function(e,t,n){var r=(arguments.length>3&&void 0!==arguments[3]?arguments[3]:{}).module;r&&(n.output=(r.getInput(e.data.name)||[])[0])}},{key:"workerOutputs",value:function(e,t,n){var r=(arguments.length>3&&void 0!==arguments[3]?arguments[3]:{}).module;r&&r.setOutput(e.data.name,t.input[0])}},{key:"setEngine",value:function(e){this.engine=e}}]),e}();function install(e,t){var n=t.engine,r=t.modules,u=new ModuleManager(r);u.setEngine(n),e.on("componentregister",function(t){if(t.module){var n=t.module,a=n.nodeType,o=n.socket,i=t.name;switch(a){case"input":var s=t.worker;u.registerInput(i,o),t.worker=function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];u.workerInputs.apply(u,n),s&&s.apply(t,n)};break;case"module":var c=t.builder;c&&(t.updateModuleSockets=function(t){if(removeIO(t,e),t.data.module&&r[t.data.module]){var n=r[t.data.module].data,a=u.getInputs(n),o=u.getOutputs(n);try{addIO(t,a,o)}catch(t){return e.trigger("warn",t)}}},t.builder=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.updateModuleSockets(n),e.next=3,c.call(t,n);case 3:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}());var l=t.worker;t.worker=_asyncToGenerator(regeneratorRuntime.mark(function e(){var n,r,a,o=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(n=o.length,r=new Array(n),a=0;a<n;a++)r[a]=o[a];return e.next=3,u.workerModule.apply(u,r);case 3:l&&l.apply(t,r);case 4:case"end":return e.stop()}},e)}));break;case"output":var p=t.worker;u.registerOutput(i,o),t.worker=function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];p&&p.apply(t,n),u.workerOutputs.apply(u,n)}}}})}var index={install:install};exports.default=index;
//# sourceMappingURL=/sm/e58ab6230d4a9be72ac0d2f0ce0992c219d9e383aabc4312c4c236c61106e3fe.map